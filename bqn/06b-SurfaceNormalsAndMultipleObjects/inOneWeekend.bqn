# https://raytracing.github.io/books/RayTracingInOneWeekend.html

WritePPM â‡ {
  # ar is nrowsÃ—ncolsÃ—3 array, final axis is rgb, floats in [0,1]
  path ğ•Š a:
  nrowsâ€¿ncols â† 2â†‘â‰¢a
  path â€¢file.Lines âŸ¨
    "P3"
    (â€¢Fmt ncols)âˆ¾" "âˆ¾(â€¢Fmt nrows)
    (â€¢Fmt 255)
  âŸ© âˆ¾ â¥Š (âŠ£âˆ¾" "âŠ¸âˆ¾)Â´Â¨ <â‰1 â€¢FmtÂ¨ âŒŠ255.999Ã—a
}

ShowArray â† {
  ğ•Š a:
  FirstLast3 â† {
    ğ•Š b:
    FmtSpc â† {
      ğ•Š c:
      (â€¢Fmt c)âˆ¾" "
    }
    â€¢Out (âˆ¾ FmtSpcÂ¨ <Ë˜3â†‘b)âˆ¾"... "âˆ¾(âˆ¾ FmtSpcÂ¨ <Ë˜Â¯3â†‘b)
  }
  FirstLast3Â¨ <Ë˜3â†‘a
  â€¢OutâŸ3 "."
  FirstLast3Â¨ <Ë˜Â¯3â†‘a
}

LengthSquared â† +Â´â‹†âŸœ2

Length â† âˆšLengthSquared

UnitVector â† Ã·âŸœLength

DotVV â‡ {
  ğ•¨ +Ëâˆ˜Ã—â‰1â€¿âˆ ğ•©
}

RayAt â‡ {
  r ğ•Š t:
  originâ€¿direction â† (3âŠ¸â†‘â‹ˆ3âŠ¸â†“) r
  origin + direction Ã— t
}

SetFaceNormal â† {
  râ€¿outward_normal:
  originâ€¿direction â† (3âŠ¸â†‘â‹ˆ3âŠ¸â†“) r
  front_face â† (âŠ‘ direction DotVV outward_normal) < 0
  normal â† front_face âŠ‘ âŸ¨
    - outward_normal
    outward_normal
  âŸ©
  normalâ€¿front_face
}

HitSphere â† {
  centerâ€¿radiusâ€¿râ€¿t_minâ€¿t_max:
  originâ€¿direction â† (3âŠ¸â†‘â‹ˆ3âŠ¸â†“) r
  hit â† 0
  rec â† @
  oc â† origin - center
  a â† LengthSquared direction
  half_b â† âŠ‘ oc DotVV direction
  c â† (LengthSquared oc) - radius Ã— radius
  discriminant â† âŠ‘ (half_b Ã— half_b) - a Ã— c
  â€¢Out (â€¢Repr r)âˆ¾", "âˆ¾(â€¢Repr oc)âˆ¾", "âˆ¾(â€¢Repr a)âˆ¾", "âˆ¾(â€¢Repr half_b)âˆ¾", "âˆ¾(â€¢Repr c)âˆ¾", "âˆ¾(â€¢Repr discriminant)
  {ğ•¤
    sqrtd â† âˆšdiscriminant
    root â† ((-half_b) - sqrtd) Ã· a
    â€¢Out (â€¢Repr sqrtd)âˆ¾", "
    â€¢Out (â€¢Repr root)âˆ¾", "
    RootBad â† { (ğ•© < t_min) âˆ¨ (ğ•© > t_max) }
    (RootBad root) â—¶ âŸ¨
      {ğ•¤
        hit â†© 1
      }
      {ğ•¤
        root â†© ((-half_b) + sqrtd) Ã· a
        â€¢Out (â€¢Repr root)âˆ¾", "
        {ğ•¤
          hit â†© 1
        } âŸ (Â¬ RootBad root) @
      }
    âŸ© @
    rec â†© hit âŠ‘ âŸ¨
      @
      {
        t â‡ root
        p â‡ r RayAt t
        outward_normal â† (p - center) Ã· radius
        normalâ€¿front_face â‡ SetFaceNormal râ€¿outward_normal
      }
    âŸ©
  } âŸ (discriminant â‰¥ 0) @
  hitâ€¿rec
}

WorldHit â‡ {
  world ğ•Š râ€¿t_minâ€¿t_max:
  rec â† @
  hit_anything â† 0
  closest_so_far â† t_max
  {
    centerâ€¿radius:
    hitâ€¿temp_rec â† HitSphere centerâ€¿radiusâ€¿râ€¿t_minâ€¿closest_so_far
    {ğ•¤
      hit_anything â†© 1
      closest_so_far â†© temp_rec.t
      rec â†© temp_rec
    } âŸ hit @
  }Â¨ world.spheres
  hit_anythingâ€¿rec
}

RayColor â† {
  world ğ•Š r:
  hitâ€¿rec â† world WorldHit râ€¿0â€¿âˆ
  hit â—¶ âŸ¨
    {ğ•¤
      originâ€¿direction â† (3âŠ¸â†‘â‹ˆ3âŠ¸â†“) r
      unit_direction â† UnitVector direction
      t â† 0.5 Ã— (1âŠ‘unit_direction) + 1
      ((1 - t) Ã— 1â€¿1â€¿1) + t Ã— 0.5â€¿0.7â€¿1
    }
    {ğ•¤
      0.5 Ã— rec.normal + 1â€¿1â€¿1
    }
  âŸ© @
}

# Image

aspect_ratio â† 16.0 Ã· 9.0
image_width â† 400
image_height â† image_width Ã· aspect_ratio

# World

world â† {
  spheres â‡ âŸ¨
    âŸ¨0â€¿0â€¿Â¯1, 0.5âŸ©
    âŸ¨0â€¿Â¯100.5â€¿Â¯1, 100âŸ©
  âŸ©
}

# Camera

viewport_height â† 2.0
viewport_width â† aspect_ratio Ã— viewport_height
focal_length â† 1.0

origin â† 0â€¿0â€¿0
horizontal â† viewport_widthâ€¿0â€¿0
vertical â† 0â€¿viewport_heightâ€¿0
lower_left_corner â† origin - (horizontalÃ·2) + (verticalÃ·2) + 0â€¿0â€¿focal_length

# Render

ijs â† > (âŒ½â†•image_height) (âŒ½â‹ˆ)âŒœ (â†•image_width)
uvs â† âŸ¨image_width - 1, image_height - 1âŸ© Ã·Ëœâ‰1 ijs
rays â† {
  uâ€¿v:
  origin âˆ¾ lower_left_corner + (u Ã— horizontal) + (v Ã— vertical) - origin
} â‰1 uvs
image â† { world RayColor ğ•© } â‰1 rays

#ShowArray âŒŠ1000Ã—image
#ShowArray image

"image.ppm" WritePPM image
