# https://raytracing.github.io/books/RayTracingInOneWeekend.html

WritePPM â‡ {
  # ar is nrowsÃ—ncolsÃ—3 array, final axis is rgb, floats in [0,1]
  path ğ•Š a:
  nrowsâ€¿ncols â† 2â†‘â‰¢a
  path â€¢file.Lines âŸ¨
    "P3"
    (â€¢Fmt ncols)âˆ¾" "âˆ¾(â€¢Fmt nrows)
    (â€¢Fmt 255)
  âŸ© âˆ¾ â¥Š (âŠ£âˆ¾" "âŠ¸âˆ¾)Â´Â¨ <â‰1 â€¢FmtÂ¨ âŒŠ255.999Ã—a
}

ShowArray â† {
  ğ•Š a:
  FirstLast3 â† {
    ğ•Š b:
    FmtSpc â† {
      ğ•Š c:
      (â€¢Fmt c)âˆ¾" "
    }
    â€¢Out (âˆ¾ FmtSpcÂ¨ <Ë˜3â†‘b)âˆ¾"... "âˆ¾(âˆ¾ FmtSpcÂ¨ <Ë˜Â¯3â†‘b)
  }
  FirstLast3Â¨ <Ë˜3â†‘a
  â€¢OutâŸ3 "."
  FirstLast3Â¨ <Ë˜Â¯3â†‘a
}

LengthSquared â† +Â´â‹†âŸœ2

Length â† âˆšLengthSquared

UnitVector â† Ã·âŸœLength

DotVV â‡ {
  ğ•¨ +Ëâˆ˜Ã—â‰1â€¿âˆ ğ•©
}

RayAt â‡ {
  r ğ•Š t:
  originâ€¿direction â† (3âŠ¸â†‘â‹ˆ3âŠ¸â†“) r
  origin + direction Ã— t
}

HitSphere â† {
  centerâ€¿radiusâ€¿r:
  originâ€¿direction â† (3âŠ¸â†‘â‹ˆ3âŠ¸â†“) r
  oc â† origin - center
  a â† direction DotVV direction
  b â† 2 Ã— oc DotVV direction
  c â† (oc DotVV oc) - radius Ã— radius
  discriminant â† âŠ‘ (b Ã— b) - 4 Ã— a Ã— c
  (discriminant < 0) â—¶ âŸ¨
    {ğ•¤
      âŠ‘ ((-b) - âˆšdiscriminant) Ã· 2 Ã— a
    }
    {ğ•¤
      Â¯1
    }
  âŸ© @
}

RayColor â† {
  ğ•Š r:
  originâ€¿direction â† (3âŠ¸â†‘â‹ˆ3âŠ¸â†“) r
  t â† HitSphere âŸ¨0, 0, Â¯1âŸ©â€¿0.5â€¿r
  (t > 0) â—¶ âŸ¨
    {ğ•¤
      unit_direction â† UnitVector direction
      t â† 0.5 Ã— (1âŠ‘unit_direction) + 1
      ((1 - t) Ã— 1â€¿1â€¿1) + t Ã— 0.5â€¿0.7â€¿1
    }
    {ğ•¤
      n â† UnitVector (r RayAt t) - 0â€¿0â€¿Â¯1
      0.5 Ã— n + 1
    }
  âŸ© @
}

# Image

aspect_ratio â† 16.0 Ã· 9.0
image_width â† 400
image_height â† image_width Ã· aspect_ratio

# Camera

viewport_height â† 2.0
viewport_width â† aspect_ratio Ã— viewport_height
focal_length â† 1.0

origin â† 0â€¿0â€¿0
horizontal â† viewport_widthâ€¿0â€¿0
vertical â† 0â€¿viewport_heightâ€¿0
lower_left_corner â† origin - (horizontalÃ·2) + (verticalÃ·2) + 0â€¿0â€¿focal_length

# Render

ijs â† > (âŒ½â†•image_height) (âŒ½â‹ˆ)âŒœ (â†•image_width)
uvs â† âŸ¨image_width - 1, image_height - 1âŸ© Ã·Ëœâ‰1 ijs
rays â† {
  uâ€¿v:
  origin âˆ¾ lower_left_corner + (u Ã— horizontal) + (v Ã— vertical) - origin
} â‰1 uvs
image â† RayColor â‰1 rays

#ShowArray âŒŠ1000Ã—image
#ShowArray image

"image.ppm" WritePPM image
