Dot â‡ {
  1â‰¡âŠ‘â‰ ğ•¨? â‰+Â´ (â¥Šğ•¨) Ã— <Ë˜ ğ•©;
  1â‰¡1âŠ‘â‰¢ğ•©? (â‰ ğ•¨)â€¿1â¥Š (+Â´(â¥Šğ•©)âŠ¸Ã—)Ë˜ğ•¨;
  ğ•¨ +Ëâˆ˜Ã—â‰1â€¿âˆ ğ•©
}

DotVV â‡ {
  ğ•¨ +Ëâˆ˜Ã—â‰1â€¿âˆ ğ•©
}

LengthSquared â‡ {
  âŠ‘ +Â´âˆ˜â‹†âŸœ2ğ•©
}

Length â‡ {
  âˆš LengthSquared ğ•©
}

Unit â‡ (âŠ¢Ã·Length)

SetFaceNormal â† {
  râ€¿outward_normal:
  originâ€¿direction â† (3âŠ¸â†‘â‹ˆ3âŠ¸â†“) r
  #â€¢Show âŠ‘ direction DotVV outward_normal
  front_face â† 0 > âŠ‘ direction DotVV outward_normal
  normal â† front_face âŠ‘ (-outward_normal)â€¿outward_normal
  #normal â† front_face âŠ‘ (outward_normal)â€¿(-outward_normal)
  #â€¢Show normal
  normalâ€¿front_face
}

HitSphere â‡ {
  centerâ€¿radiusâ€¿râ€¿t_minâ€¿t_max:
  originâ€¿direction â† (3âŠ¸â†‘â‹ˆ3âŠ¸â†“) r
  rec â† {
    p â‡ @  # 3
    normal â‡ @  # 3
    t â‡ @  # double
    front_face â‡ @  # bool
  }
  oc â† origin - center
  a â† LengthSquared direction
  half_b â† âŠ‘ oc DotVV direction
  c â† (LengthSquared oc) - radiusâ‹†2
  discriminant â† (half_bâ‹†2) - a Ã— c
  #â€¢Out (â€¢Repr oc)âˆ¾", "âˆ¾(â€¢Repr a)âˆ¾", "âˆ¾(â€¢Repr b)âˆ¾", "âˆ¾(â€¢Repr c)âˆ¾", "âˆ¾(â€¢Repr discriminant)
  (discriminant < 0) â—¶ âŸ¨
    {ğ•¤
      sqrtd â† âˆšdiscriminant
      root â† ((-half_b) - sqrtd) Ã· a
      âŸ¨
        root â†© ((-half_b) + sqrtd) Ã· a
      âŸ© âŸ ((root < t_min) âˆ¨ (root > t_max)) @
      ((root < t_min) âˆ¨ (root > t_max)) â—¶ âŸ¨
        {ğ•¤
          rec â†© {
            t â‡ root
            p â‡ r RayAt t
            outward_normal â† (p - center) Ã· radius
            #normalâ€¿front_face â† SetFaceNormal râ€¿outward_normal
            nmâ€¿ff â† SetFaceNormal râ€¿outward_normal
            normal â‡ nm
            front_face â‡ ff
          }
          1â€¿rec
        }
        {ğ•¤
          0â€¿rec
        }
      âŸ© @
    }
    {ğ•¤
      0â€¿rec
    }
  âŸ© @
  #(discriminant < 0) â—¶ âŸ¨((-half_b) - âˆšdiscriminant) Ã· a, Â¯1âŸ© @
}

WorldHit â‡ {
  worldâ€¿râ€¿t_minâ€¿t_max:
  rec â† {
    p â‡ @  # 3
    normal â‡ @  # 3
    t â‡ @  # double
    front_face â‡ @  # bool
  }
  hit_anything â† 0
  closest_so_far â† t_max
  {
    centerâ€¿radius:
    #â€¢Show centerâ€¿radius
    hitâ€¿temp_rec â† HitSphere centerâ€¿radiusâ€¿râ€¿t_minâ€¿closest_so_far
    {ğ•¤
      hit_anything â†© 1
      closest_so_far â†© temp_rec.t
      rec â†© temp_rec
    } âŸ (hit) @
  }Â¨ world.spheres
  hit_anythingâ€¿rec
}

RayAt â‡ {
  r ğ•Š t:
  originâ€¿direction â† (3âŠ¸â†‘â‹ˆ3âŠ¸â†“) r
  origin + direction Ã— t
}

WritePPM â‡ {
  # ar is nrowsÃ—ncolsÃ—3 array, final axis is rgb, floats in [0,1]
  path ğ•Š a:
  nrowsâ€¿ncols â† 2â†‘â‰¢a
  path â€¢file.Lines âŸ¨
    "P3"
    (â€¢Fmt ncols)âˆ¾" "âˆ¾(â€¢Fmt nrows)
    (â€¢Fmt 255)
  âŸ© âˆ¾ â¥Š (âŠ£âˆ¾" "âŠ¸âˆ¾)Â´Â¨ <â‰1 â€¢FmtÂ¨ âŒŠ255.999Ã—a
}
